{"componentChunkName":"component---src-templates-note-template-tsx","path":"/ecto/multi","result":{"data":{"markdownRemark":{"html":"<ul>\n<li>runs in order</li>\n<li>group database operations into a data structure</li>\n<li>easy to track errors because of the return value</li>\n<li>when Multi contains operations that uses changesets, if one of the changesets is invalid, it won't bother sending it to database,\nbecause of this behaviour, prefer to use changesets when using Multi</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"elixir\"><pre class=\"language-elixir\"><code class=\"language-elixir\">user <span class=\"token operator\">=</span> User<span class=\"token punctuation\">.</span>changeset<span class=\"token punctuation\">(</span><span class=\"token punctuation\">%</span>User<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">%</span><span class=\"token punctuation\">{</span><span class=\"token attr-name\">firstname:</span> <span class=\"token string\">\"Tony\"</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">lastname:</span> <span class=\"token string\">\"Stark\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nmulti <span class=\"token operator\">=</span>\n  Ecto<span class=\"token punctuation\">.</span>Multi<span class=\"token punctuation\">.</span>new<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token operator\">|></span> Ecto<span class=\"token punctuation\">.</span>Multi<span class=\"token punctuation\">.</span>insert<span class=\"token punctuation\">(</span><span class=\"token atom symbol\">:user</span><span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">)</span>\n  <span class=\"token operator\">|></span> Ecto<span class=\"token punctuation\">.</span>Multi<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span><span class=\"token atom symbol\">:profile</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">fn</span> repo<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">%</span><span class=\"token punctuation\">{</span><span class=\"token attr-name\">user:</span> user<span class=\"token punctuation\">}</span> <span class=\"token operator\">-></span>\n    user\n    <span class=\"token operator\">|></span> Ecto<span class=\"token punctuation\">.</span>build_assoc<span class=\"token punctuation\">(</span><span class=\"token atom symbol\">:profiles</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">|></span> Profile<span class=\"token punctuation\">.</span>changeset<span class=\"token punctuation\">(</span><span class=\"token punctuation\">%</span><span class=\"token punctuation\">{</span><span class=\"token attr-name\">role:</span> <span class=\"token string\">\"avenger\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">|></span> repo<span class=\"token punctuation\">.</span>insert<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span>\n\nRepo<span class=\"token punctuation\">.</span>transaction<span class=\"token punctuation\">(</span>multi<span class=\"token punctuation\">)</span></code></pre></div>","frontmatter":{"date":"March 12, 2021","path":"/ecto/multi","title":"Multi","category":"Ecto"}}},"pageContext":{}}}